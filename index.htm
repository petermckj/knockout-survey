<html>
	<head>
		<title></title>
		
	</head>
	<body>
		<fieldset>
			<div id="error" data-bind="text: errorMessage, visible: (getAnswersToQuestion(getIndex()).length===0)"></div>
			<div id="question-view" data-bind="with: currentQuestion">
				<span data-bind="text: questionNumber">
				</span>.
				<span data-bind="text: questionText">
				</span>
				<br />
				<ul id="answer-view" data-bind="template: {name: $parent.questionMode, foreach: answers, as: 'answer'}">
				</ul>
			</div>
			<div id="button-view">
				<button data-bind="click: previousQuestion, visible: getIndex()>0">Previous Question</button>
				<button data-bind="click: nextQuestion, visible: isFinished()">Next Question</button>
				<button data-bind="click: finishSurvey, visible: (isFinished() ? false : true)">Finish Survey</button>
			</div>
		</fieldset>
		<script type="text/html" id="multiAnswerTemplate">
			<li>
				<input type="checkbox" data-bind="value: answerText,checked: isSelected" />
				<label data-bind="text: answerText"></label>
			</li>
		</script>
		<script type="text/html" id="answerTemplate">
			<li>
				<input id="answersGroup" name="answersGroup" type="radio" data-bind="value: answerText,checked: isSelected" />
				<label data-bind="text: answerText"></label>
			</li>
		</script>
		<script src="js/knockout-latest.debug.js" type="text/javascript" charset="utf-8"></script>
		<script>
			window.survey ={};
			
			ko.observableArray.fn['filter'] = function(filter){
				var a = this();
				var result = [];
				for(vari=0;i<a.length;i++){
					var v = a[i];
					if(filter(a)){
						result.push(v);
					}
				}
				return result;
			};
			
			(function (survey) {
				function Answer(){
					var self = this;
					self.answerId = ko.observable(0);
					self.answerText = ko.observable("answer lorem ipsem");
					self.isSelected = ko.observable(false);
					return self;
				}
				survey.Answer = Answer;
			})(window.survey);
			
			(function (survey) {
				function Question(){
					var self = this;
					self.questionNumber = ko.observable(0);
					self.questionType = ko.observable("multiple");
					self.questionText = ko.observable("lorem ipsem");
					//self.selectedAnswer = ko.observable();
					
					self.answers = ko.observableArray([
						new survey.Answer().answerText("test").answerId(1),
						new survey.Answer().answerText("test 2").answerId(2)
					]);
					return self;
				}
				survey.Question = Question;
			})(window.survey);
			
			(function (survey){
				function SurveyViewModel(){
					var self = this;
					self.userID = 1; //should be assigned on load somehow
					self.questions = ko.observableArray([]);
					self.currentQuestion = ko.observable(null);
					self.errorMessage = ko.observable(null);
					
					self.setUserID = function(uid){
						self.userID = uid;
					};
					
					self.getIndex = function(){
						return self.questions.indexOf(self.currentQuestion());
					};
					
					self.isFinished = ko.computed(function(){
						return (self.getIndex()+1 < self.questions().length);
					});
					
					self.questionMode =  function(question, bindingContext){
						if(bindingContext.$parent.questionType() === "multiple"){
							return "multiAnswerTemplate";
						}else{
							return "answerTemplate";
						}
					};
					
					self.getAnswersToQuestion = function(index){
						return self.questions()[index].answers().filter(function (item) {
							return item.isSelected() === false ? false : true;
						});
					}
					
					self.nextQuestion = function(){
						var index = self.getIndex();
						
						//do some validation here
						if(self.getAnswersToQuestion(index).length === 0){
							self.errorMessage("Please select an answer");
							return;
						}
						self.errorMessage(null);
						
						//should send users response to server to be stored
						//or maybe put in local storage
						//does knockout do that for us anyway?
						//$.POST(...);
						
						//find our current question in the array
						
						if(index+1 < self.questions().length){
							self.currentQuestion(self.questions()[index+1]);
						}
					};
					
					/*
					*
					TODO
					Need to somehow switch templates based on the type of question that is 
					being shown eg multi-choice, single choice etc.
					*
					*/
					
					/*
					*
					TODO
					Need to add routing logic based on previous answers.
					*
					*/
					
					self.previousQuestion = function(){
						var index = self.getIndex();
						if(index > 0){
							self.currentQuestion(self.questions()[index-1]);
						}
					};
					
					self.finishSurvey = function(){
						for(var i = 0; i < self.questions().length; i++){
							var q = self.questions()[i];
							var a = self.getAnswersToQuestion(i);
							console.log(q.questionNumber() + ":");
							for(var x = 0; x < a.length;x++){
								console.log(a[x].answerText());
							}
						}
						//this function should validate and submit responses
						//to server using AJAX / JSON
					};
					
					self.addQuestion = function(question){
						self.questions.push(question);
						self.currentQuestion(question);
					};
					
					self.addQuestions = function(questionsToAdd){
						for(var i = 0; i < questionsToAdd.length; i++){
							self.questions.push(questionsToAdd[i]);
						}
						self.currentQuestion(questionsToAdd[0]);
					};
				}
				survey.SurveyViewModel = SurveyViewModel;
			})(window.survey);
			
			var ViewModel = new survey.SurveyViewModel();
			
			//load survey in via JSON
			//foreach(question q in questions)...
			//load from mongodb document db
			var q = new survey.Question().questionText('super').questionNumber(1).questionType("single");
			var q2 = new survey.Question().questionText('smashing').questionNumber(2);
			var q3 = new survey.Question().questionText('great').questionNumber(3).questionType("single");
			ViewModel.addQuestions([q,q2,q3]);
			
			ko.applyBindings(ViewModel);
			
		</script>
	</body>
</html>